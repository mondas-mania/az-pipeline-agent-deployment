# Terraform Container Instance Deployment

A simple sandbox test for deploying the previously-built Azure Pipeline Agent container image into Azure Container Instances. Uses existing networking.

## Caveats

- This has to be run as the final stage of deployment as this relies on stage 0 (deploying the ACR registry) and stage 1 (building and pushing the container image to the ACR registry).

## Example Variables File

This will deploy a single-container solution using Container Instances into `internal-vnet-1/private-subnet-1` pulling the image `SandpitPipelineAgent.azurecr.io/azp-agent:windows`.

This agent will connect to the `contoso` organisation in Azure DevOps and act as a Pipelines agent in the `MyPool` pool using the specified PAT token.
- The specified Agent Pool must already exist. It cannot be created by the Agent Container deployment. This documentation covers how to create an Agent Pool ([x](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/pools-queues?view=azure-devops&tabs=yaml%2Cbrowser#create-agent-pools)).

This PAT token will be a secured environment variable in the container and act as a sensitive value in Terraform plans but will still be stored as plain text in the state.
- It also is not possible to use a service connection for the default Azure Pipelines Agent image so this PAT token will need to be generated by a user of some sorts.
- A PAT Token for the Azure Agent only needs the `Agent Pools (Read, Manage)` privileges in Azure DevOps.


```hcl
resource_group_name = "Sandbox_RG"
vnet_name           = "internal-vnet-1"
subnet_name         = "private-subnet-1"

number_of_agents = 1

acr_registry_name = "SandpitPipelineAgent"
acr_image_name    = "azp-agent"
acr_image_tag     = "windows"

azure_devops_url        = "https://dev.azure.com/contoso"
azure_devops_agent_pool = "MyPool"
pat_token               = "0000000000000000000000000000000000000000000000000000"
```

<!-- BEGINNING OF PRE-COMMIT-OPENTOFU DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | ~> 1.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | ~> 3.0 |
| <a name="requirement_random"></a> [random](#requirement\_random) | ~> 3.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | ~> 3.0 |
| <a name="provider_random"></a> [random](#provider\_random) | ~> 3.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azurerm_container_group.pipeline_agent](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_group) | resource |
| [azurerm_key_vault.agent_key_vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault) | resource |
| [azurerm_key_vault_secret.pat_token](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret) | resource |
| [random_string.key_vault_random_string](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string) | resource |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) | data source |
| [azurerm_container_registry.acr_registry](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/container_registry) | data source |
| [azurerm_resource_group.resource_group](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/resource_group) | data source |
| [azurerm_subnet.subnet](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subnet) | data source |
| [azurerm_virtual_network.vnet](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/virtual_network) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_acr_image_name"></a> [acr\_image\_name](#input\_acr\_image\_name) | The name of the image to pull from `acr_registry_name`. | `string` | `"azp-agent"` | no |
| <a name="input_acr_image_tag"></a> [acr\_image\_tag](#input\_acr\_image\_tag) | The name of the tag for the image `acr_image_name` in `acr_registry_name`. | `string` | `"windows"` | no |
| <a name="input_acr_registry_name"></a> [acr\_registry\_name](#input\_acr\_registry\_name) | The name of the ACR Registry to pull from. | `string` | n/a | yes |
| <a name="input_azure_devops_agent_pool"></a> [azure\_devops\_agent\_pool](#input\_azure\_devops\_agent\_pool) | The name of an existing Pipeline Agent Pool in your DevOps organisation. | `string` | `"Default"` | no |
| <a name="input_azure_devops_url"></a> [azure\_devops\_url](#input\_azure\_devops\_url) | The URL of your Azure DevOps instance. This will typically be https://dev.azure.com/{instance} | `string` | n/a | yes |
| <a name="input_number_of_agents"></a> [number\_of\_agents](#input\_number\_of\_agents) | The number of agents to deploy. Each agent will constitute its own Container Instance deployment.<br>  Set to 0 to disable Container Instance deployments. | `number` | `1` | no |
| <a name="input_pat_token"></a> [pat\_token](#input\_pat\_token) | The PAT Token for the Pipeline Agent to run with. This needs Agent Pool (Read, Manage) permissions.<br>  This will be stored in plaintext in the state. | `string` | n/a | yes |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | The name of the resource group to deploy to. | `string` | n/a | yes |
| <a name="input_subnet_name"></a> [subnet\_name](#input\_subnet\_name) | The name of the Subnet in `vnet_name` to deploy the Container Apps solution into.<br>  This subnet must be delegated to `Microsoft.ContainerInstance/containerGroups`. | `string` | n/a | yes |
| <a name="input_vnet_name"></a> [vnet\_name](#input\_vnet\_name) | The name of the VNet to deploy the Container Apps solution into. | `string` | n/a | yes |

## Outputs

No outputs.
<!-- END OF PRE-COMMIT-OPENTOFU DOCS HOOK -->
